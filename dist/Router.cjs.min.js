"use strict";function _interopDefault(a){return a&&"object"==typeof a&&"default"in a?a["default"]:a}var ExceptionHandler=_interopDefault(require("jb-modules/ExceptionHandler/ExceptionHandler")),React=_interopDefault(require("react")),ReactDOM=_interopDefault(require("react-dom"));function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var Route=function(){function a(b){_classCallCheck(this,a),_defineProperty(this,"url",null),_defineProperty(this,"name",null),_defineProperty(this,"settings",{}),_defineProperty(this,"title",""),_defineProperty(this,"isRoot",void 0),_defineProperty(this,"params",void 0),_defineProperty(this,"regex",void 0),this.url=b.url,this.name=b.name,this.title=b.title,this.settings=b.settings,this.isRoot="/"==this.url,this.params={},this.regex=new RegExp(this.url.concat("$").toLowerCase().replace(/\{\w+\}/g,"([\\w-]+)")),this._extractUrlParamsKey()}return _createClass(a,[{key:"_extractUrlParamsKey",value:function(){for(var a,b=new RegExp(/\{(\w+)\}/g);a=b.exec(this.url);)this.params[a[1]]=null}},{key:"load",value:function(){alert("not implemented")}},{key:"_loadResource",value:function(a){return new Promise(function(b,c){SystemJS.import(a).then(function(a){b(a)}).catch(function(a){c(a)})})}}]),a}();function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _classCallCheck$1(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties$1(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass$1(a,b,c){return b&&_defineProperties$1(a.prototype,b),c&&_defineProperties$1(a,c),a}function _possibleConstructorReturn(a,b){return b&&("object"===_typeof(b)||"function"==typeof b)?b:_assertThisInitialized(a)}function _getPrototypeOf(a){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)},_getPrototypeOf(a)}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&_setPrototypeOf(a,b)}function _setPrototypeOf(a,b){return _setPrototypeOf=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a},_setPrototypeOf(a,b)}function _assertThisInitialized(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _defineProperty$1(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var ReactRoute=function(a){function b(a){var c;return _classCallCheck$1(this,b),c=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this,a)),_defineProperty$1(_assertThisInitialized(_assertThisInitialized(c)),"componentPath",null),c.componentPath=a.reactComponentPath,c}return _inherits(b,a),_createClass$1(b,[{key:"load",value:function(){var a=this;return new Promise(function(b,c){a._loadResource(a.componentPath).then(function(a){a.default?b(a.default):c({message:"the react component you want to load and initiate does not export defualt class to initiate. please add <export defualt ClassName> in your js file"})}).catch(function(a){c(a)})})}},{key:"loadge",value:function(a,b){return new Promise(function(c){ReactDOM.unmountComponentAtNode(b),ReactDOM.render(React.createElement(a,null),b,function(){c(a)})})}}]),b}(Route);function _classCallCheck$2(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var RouteFactory=function a(b){switch(_classCallCheck$2(this,a),b.type){case"REACT":return new ReactRoute(b);break;case void 0:return new Route(b);}};function _objectSpread(a){for(var b=1;b<arguments.length;b++){var c=null==arguments[b]?{}:arguments[b],d=Object.keys(c);"function"==typeof Object.getOwnPropertySymbols&&(d=d.concat(Object.getOwnPropertySymbols(c).filter(function(a){return Object.getOwnPropertyDescriptor(c,a).enumerable}))),d.forEach(function(b){_defineProperty$2(a,b,c[b])})}return a}function _typeof$1(a){return _typeof$1="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof$1(a)}function _classCallCheck$3(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties$2(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass$2(a,b,c){return b&&_defineProperties$2(a.prototype,b),c&&_defineProperties$2(a,c),a}function _defineProperty$2(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var instance=[],_loadStateKey=Symbol(),Router=function(){function a(b){var c=this;if(_classCallCheck$3(this,a),_defineProperty$2(this,"treeBaseRoutes",[]),_defineProperty$2(this,"routes",[]),_defineProperty$2(this,"errorRoutes",{}),_defineProperty$2(this,"routeGroupsName",[]),_defineProperty$2(this,"basePath",void 0),_defineProperty$2(this,"matchedRoute",{}),_defineProperty$2(this,"componentsPathPrefix","/"),_defineProperty$2(this,"pageContainerTagId",void 0),_defineProperty$2(this,"isPageContainerMounted",!1),_defineProperty$2(this,"params",{}),_defineProperty$2(this,"currentPage",{routeDataObject:{},params:{},jsClass:null}),_defineProperty$2(this,"pagesTitlePrefix",""),_defineProperty$2(this,"loadState",void 0),_defineProperty$2(this,"config",{instanceName:"defualt",events:{onLoadStateChange:null}}),"object"==_typeof$1(b)&&Object.assign(this.config,b),!instance[this.config.instanceName])instance[this.config.instanceName]=this;else return instance[this.config.instanceName];return this.treeBaseRoutes=this.config.routes,this.basePath=this.config.basePath,this.pageContainerTagId=this.config.pageContainerTagId,this.componentsPathPrefix=this.config.componentsPathPrefix,this.pagesTitlePrefix=this.config.pagesTitlePrefix,this._initLoadState(),this._normalizeAndOptimazeRoutes(),window.addEventListener("popstate",function(a){return c._onBrowserPopState(a)}),instance[this.config.instanceName]}return _createClass$2(a,[{key:"pageContainerDidMount",value:function(){return this.containerDom=document.getElementById(this.pageContainerTagId),this.containerDom?void(this.isPageContainerMounted=!0):(ExceptionHandler.newException("router can't find dom with "+this.pageContainerTagId+" ID maybe your html page is not ready yet"),!1)}},{key:"_initLoadState",value:function(){this[_loadStateKey]=null}},{key:"_callLoadStateChange",value:function(a,b){this.config.events.onLoadStateChange&&this.config.events.onLoadStateChange(a,b)}},{key:"_onBrowserPopState",value:function(a){var b=a.state;return b&&b.pushedByJBRouter&&this.loadPage(b.absolutePath,!1),!0}},{key:"_normalizeAndOptimazeRoutes",value:function(){var a=this;(function b(c,d,e){var f=!0,g=!1,h=void 0;try{for(var i,j,k=c[Symbol.iterator]();!(f=(i=k.next()).done);f=!0){j=i.value,j.settings=Object.assign(j.settings||{},e),j.url=d+j.url,j.reactComponentPath&&(j.reactComponentPath=a.componentsPathPrefix+j.reactComponentPath);var l=new RouteFactory(j);a.routes.push(l),j.childRoutes&&b(j.childRoutes,l.url,l.settings)}}catch(a){g=!0,h=a}finally{try{f||null==k.return||k.return()}finally{if(g)throw h}}})(this.treeBaseRoutes,"",{}),this.config.standardPageRoutes[404]&&(this.errorRoutes[404]=new RouteFactory(this.config.standardPageRoutes[404])),this.config.standardPageRoutes[424]&&(this.errorRoutes[424]=new RouteFactory(this.config.standardPageRoutes[424]))}},{key:"_matchPathToOneRoute",value:function(a){var b,c=!0,d=!1,e=void 0;try{for(var f,g,h=this.routes[Symbol.iterator]();!(c=(f=h.next()).done);c=!0)if(g=f.value,"/"==a&&g.isRoot){b=g;break}else if("/"!=a&&!g.isRoot&&(b=a.match(g.regex),b)){var j=1;for(var k in g.params)g.params[k]=b[j++];b=g,this.params=g.params;break}}catch(a){d=!0,e=a}finally{try{c||null==h.return||h.return()}finally{if(d)throw e}}return this.matchedRoute=b?b:this.errorRoutes[404],this.matchedRoute}},{key:"loadPage",value:function(a,b){if(!this.isPageContainerMounted)return ExceptionHandler.newException("router can`t load route and render it before 'pageContainerDidMount' function called"),!1;var c=this._normalizePath(a);if(-1!=c){var d=this._matchPathToOneRoute(c);if(d){var e=!0;if(null!=d.componentPath&&null!=d.componentPath||(e=!1,ExceptionHandler.newException(new Error(d),"the matched Route we find dosent have any component path to load. /n please define component path so we can load and place it")),e)return this._callLoadStateChange(this[_loadStateKey],0),this[_loadStateKey]=0,this._loadComponent(d),this._setPageAttributes(d.title,a,b),d}else return ExceptionHandler.newException(new Error(a),"\u0622\u062F\u0631\u0633 \u0648\u0627\u0631\u062F \u0634\u062F\u0647 \u06CC\u0627\u0641\u062A \u0646\u0634\u062F"),-1}else return ExceptionHandler.newException(new Error(a,"\u0622\u062F\u0631\u0633 \u0648\u0627\u0631\u062F \u0634\u062F\u0647 \u06CC\u0627\u0641\u062A \u0646\u0634\u062F")),-1}},{key:"_loadComponent",value:function(a){var b=this;a.load().then(function(c){b._onRouteLoadComplete(a,c)}).catch(function(c){b._onRouteLoadError(c,a)})}},{key:"_setPageAttributes",value:function(a,b){var c=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];if(document.title=a+" | "+this.pagesTitlePrefix,c){var d={pushedByJBRouter:!0,routeObject:this.matchedRoute,absolutePath:b};window.history.pushState(d,this.pagesTitlePrefix+a,b)}}},{key:"_onRouteLoadComplete",value:function(a,b){var c=this;this._callLoadStateChange(this[_loadStateKey],1),this[_loadStateKey]=1,a.loadge(b,this.containerDom).then(function(a){c._onRouteLoadgeComplete(a)}).catch(function(a){ExceptionHandler.newException(a,"we have exception in loadge the page. \n"),c._onRouteLoadError(a,reactRoute)})}},{key:"_onRouteLoadError",value:function(a,b){var c=this;ExceptionHandler.newException(a,"\u062F\u0631 \u0647\u0646\u06AF\u0627\u0645 \u0644\u0648\u062F \u06A9\u0627\u0645\u067E\u0648\u0646\u0646\u062A \u0645\u0634\u06A9\u0644\u06CC \u067E\u06CC\u0634 \u0622\u0645\u062F\u0647 \u0627\u0633\u062A"),this.loadComponentTryCount?this.loadComponentTryCount++:this.loadComponentTryCount=1,6>this.loadComponentTryCount?setTimeout(function(){c._loadComponent(b)},2e3*this.loadComponentTryCount):this._loadComponent(this.errorRoutes[424])}},{key:"_onRouteLoadgeComplete",value:function(a){this.currentPage.routeDataObject=_objectSpread({},this.matchedRoute),this.currentPage.jsClass=_objectSpread({},a),this.currentPage.params=_objectSpread({},this.params),this._callLoadStateChange(this[_loadStateKey],5),this[_loadStateKey]=5}},{key:"_normalizePath",value:function(a){var b=a.toLowerCase(),c=b.indexOf(this.basePath.toLowerCase());if(-1==c)return-1;var d=b.substring(this.basePath.length,b.length);return"/"==d[d.length-1]&&"/"!=d?d=d.substring(0,d.length-1):""==d&&(d="/"),-1!=d.lastIndexOf("?")&&(d=d.slice(0,d.lastIndexOf("?"))),d}},{key:"loadState",get:function(){return this[_loadStateKey]},set:function(a){4<a&&10>a?(this._callLoadStateChange(this[_loadStateKey],a),this[_loadStateKey]=a):ExceptionHandler.newException({invalidValue:a},"\u0645\u0642\u062F\u0627\u0631 \u0633\u062A \u0634\u062F\u0647 \u0628\u0631\u0627\u06CC \u0648\u0636\u0639\u06CC\u062A \u0644\u0648\u062F\u06CC\u0646\u06AF \u0646\u0645\u06CC\u062A\u0648\u0627\u0646\u062F \u06A9\u0645\u062A\u0631 \u067E\u0646\u062C \u0648 \u0628\u06CC\u0634\u062A\u0631 \u0627\u0632 \u062F\u0647 \u0628\u0627\u0634\u062F \n")}}]),a}();module.exports=Router;
